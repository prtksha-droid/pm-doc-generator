<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Scrum Book ‚Äì User Stories & Epics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="chat-widget.css">
<script src="chat-widget.js" defer></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #f3f4f6;
      color: #111827;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.12);
    }
    h1 {
      margin-top: 0;
    }
    p {
      margin: 4px 0 12px;
      font-size: 13px;
      color: #4b5563;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #ffffff;
    }
    textarea {
      resize: vertical;
      min-height: 70px;
    }
    .section-box {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      background: #f9fafb;
      margin-top: 12px;
      margin-bottom: 12px;
    }
    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #4b5563;
      margin-bottom: 8px;
    }
    .helper {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
    }
    .status--error {
      color: #b91c1c;
    }
    .status--success {
      color: #166534;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
      margin-right: 8px;
      margin-top: 8px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .nav a {
      text-decoration: none;
      color: #2563eb;
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th,
    td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #f3f4f6;
      text-align: left;
      font-weight: 600;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 16px;
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: #ffffff;
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      font-size: 26px;
    }
    .app-name {
      font-size: 18px;
      font-weight: 700;
    }
    .app-tagline {
      font-size: 12px;
      opacity: 0.9;
    }
    .app-footer {
      margin-top: 18px;
      font-size: 11px;
      text-align: center;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="logo-row">
        <span class="logo-icon">üìò</span>
        <div class="logo-text">
          <div class="app-name">The Scrum Book</div>
          <div class="app-tagline">AI-powered Agile documentation &amp; delivery toolkit</div>
        </div>
      </div>
    </header>

    <h1 style="display:none;">The Scrum Book ‚Äì User Stories &amp; Epics</h1>

    <div class="nav">
  <span>Navigation:</span>
  <a href="/">Main ‚Äì Document Generator</a>
  <a href="/user-stories.html">User Stories &amp; Epics</a>
  <a href="/sprint-review.html">Sprint Review (AI)</a>
  <a href="/sprint-retro.html">Sprint Retrospective (AI)</a>
  <a href="/code-review.html">Code Review (Beta)</a>

</div>


    <p>
      Upload your <strong>BRD .docx</strong> file and let AI generate
      agile user stories, grouped into <strong>Epics</strong>, then export
      everything into Excel with AI-estimated Story Points and Sprint allocation ‚Äî
      all within <strong>The Scrum Book</strong>.
    </p>

    <div class="section-box">
      <div>
        <label for="usProjectName">Project Name (optional)</label>
        <input
          type="text"
          id="usProjectName"
          placeholder="Project name for Excel &amp; context (optional)"
        />
        <p class="helper">
          This will be used for naming the Excel and for context in AI.
        </p>
      </div>

      <div style="margin-top: 12px;">
        <label for="usBrdFile">BRD / Requirements Document (.docx)</label>
        <input
          type="file"
          id="usBrdFile"
          accept=".docx"
        />
        <p class="helper">
          Upload a BRD / requirements DOCX. AI will parse it to generate epics &amp; user stories.
        </p>
      </div>

      <div style="margin-top: 12px;">
        <label for="usNotes">Additional Notes / Constraints (optional)</label>
        <textarea
          id="usNotes"
          placeholder="Any extra context, constraints, personas, acceptance themes..."
        ></textarea>
      </div>

      <div style="margin-top: 12px;">
        <button id="generateStoriesBtn">Generate User Stories with AI</button>
        <div id="usStatus" class="status"></div>
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">Epics (Summary)</div>
      <div id="epicsSummary" class="helper">
        Epics will appear here once AI has generated them.
      </div>
    </div>

    <div class="section-box">
      <div class="section-title">User Stories</div>
      <p class="helper">
        AI-generated user stories for planning &amp; backlog creation. You can edit epics
        and stories before exporting.
      </p>
      <table>
        <thead>
          <tr>
            <th style="width: 15%;">ID</th>
            <th style="width: 25%;">Epic</th>
            <th style="width: 45%;">User Story</th>
            <th style="width: 15%;">Story Points</th>
          </tr>
        </thead>
        <tbody id="userStoriesTableBody">
          <!-- Filled dynamically -->
        </tbody>
      </table>
      <p class="helper">
        You can adjust the Epic name and Story Points per story. Excel export will use these values.
      </p>
    </div>

    <div class="section-box">
      <div class="section-title">User Stories (plain text)</div>
      <label>User Stories (plain text for copy)</label>
      <textarea
        id="userStoriesRaw"
        style="margin-top: 6px; font-family: monospace;"
        placeholder="User stories in plain text will appear here for easy copy..."
      ></textarea>
    </div>

    <div class="section-box">
      <div class="section-title">Email User Stories Excel (optional)</div>
      <label for="usEmailTo">Recipient Email</label>
      <input
        type="text"
        id="usEmailTo"
        placeholder="someone@example.com"
      />
      <p class="helper">
        After generating and downloading the Excel at least once, you can email it from The Scrum Book
        using your configured server-side email settings.
      </p>
      <button id="sendExcelEmailBtn" class="secondary">
        Email User Stories Excel
      </button>
      <div id="usEmailStatus" class="status"></div>
    </div>
  </div>

  <footer class="app-footer">Built with ‚ù§Ô∏è by Pratiksha Bhattacharyya ¬∑ The Scrum Book</footer>

  <script>
    const usBrdFileInput = document.getElementById("usBrdFile");
    const usProjectNameInput = document.getElementById("usProjectName");
    const usNotesInput = document.getElementById("usNotes");
    const generateStoriesBtn = document.getElementById("generateStoriesBtn");
    const usStatus = document.getElementById("usStatus");
    const epicsSummary = document.getElementById("epicsSummary");
    const userStoriesTableBody = document.getElementById("userStoriesTableBody");
    const userStoriesRaw = document.getElementById("userStoriesRaw");
    const usEmailToInput = document.getElementById("usEmailTo");
    const sendExcelEmailBtn = document.getElementById("sendExcelEmailBtn");
    const usEmailStatus = document.getElementById("usEmailStatus");

    let userStoriesArray = [];
    let epicsArray = [];
    let lastUserStoriesFileId = null;

    generateStoriesBtn.addEventListener("click", async () => {
      usStatus.textContent = "";
      usStatus.className = "status";

      const file = usBrdFileInput.files?.[0];
      if (!file) {
        usStatus.textContent = "Please upload a BRD / requirements DOCX file.";
        usStatus.classList.add("status--error");
        return;
      }

      generateStoriesBtn.disabled = true;
      usStatus.textContent = "Generating user stories with AI...";
      usStatus.classList.remove("status--error", "status--success");

      try {
        const formData = new FormData();
        formData.append("brdDocx", file);
        formData.append("projectName", usProjectNameInput.value || "");
        formData.append("notes", usNotesInput.value || "");

        const res = await fetch("/generate-user-stories", {
          method: "POST",
          body: formData
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          const msg =
            "Error: " + (err.error || "Could not generate user stories.");
          usStatus.textContent = msg;
          usStatus.classList.add("status--error");
          generateStoriesBtn.disabled = false;
          return;
        }

        const data = await res.json();
        const stories = Array.isArray(data.userStories)
          ? data.userStories
          : [];
        const epics = Array.isArray(data.epics) ? data.epics : [];

        if (stories.length === 0) {
          usStatus.textContent =
            "AI did not return any user stories. Try using a more detailed BRD.";
          usStatus.classList.add("status--error");
          generateStoriesBtn.disabled = false;
          return;
        }

        // Normalise and store
        userStoriesArray = stories.map((s) => ({
          epic: s.epic || "",
          story: s.story || "",
          storyPoints: s.storyPoints != null ? s.storyPoints : ""
        }));

        epicsArray = epics.map((e) => ({
          name: e.name || "",
          description: e.description || ""
        }));

        // Render epics summary
        if (epicsArray.length > 0) {
          epicsSummary.innerHTML = "";
          const ul = document.createElement("ul");
          epicsArray.forEach((e) => {
            if (!e.name) return;
            const li = document.createElement("li");
            li.innerHTML = `<strong>${e.name}</strong> ‚Äì ${e.description || ""}`;
            ul.appendChild(li);
          });
          epicsSummary.appendChild(ul);
        } else {
          epicsSummary.textContent =
            "No epics were generated explicitly. Stories will still be listed below.";
        }

        // Render stories table
        userStoriesTableBody.innerHTML = "";
        userStoriesArray.forEach((s, index) => {
          const tr = document.createElement("tr");

          const idCell = document.createElement("td");
          idCell.textContent = `US-${index + 1}`;
          tr.appendChild(idCell);

          const epicCell = document.createElement("td");
          const epicInput = document.createElement("input");
          epicInput.type = "text";
          epicInput.value = s.epic || "";
          epicInput.addEventListener("input", () => {
            userStoriesArray[index].epic = epicInput.value;
            updateUserStoriesRaw();
          });
          epicCell.appendChild(epicInput);
          tr.appendChild(epicCell);

          const storyCell = document.createElement("td");
          const storyTextarea = document.createElement("textarea");
          storyTextarea.value = s.story || "";
          storyTextarea.style.minHeight = "40px";
          storyTextarea.addEventListener("input", () => {
            userStoriesArray[index].story = storyTextarea.value;
            updateUserStoriesRaw();
          });
          storyCell.appendChild(storyTextarea);
          tr.appendChild(storyCell);

          const spCell = document.createElement("td");
          const spInput = document.createElement("input");
          spInput.type = "number";
          spInput.min = "0";
          spInput.step = "1";
          spInput.value =
            s.storyPoints != null && s.storyPoints !== ""
              ? s.storyPoints
              : "";
          spInput.addEventListener("input", () => {
            userStoriesArray[index].storyPoints = spInput.value;
          });
          spCell.appendChild(spInput);
          tr.appendChild(spCell);

          userStoriesTableBody.appendChild(tr);
        });

        updateUserStoriesRaw();

        usStatus.textContent =
          "User stories generated successfully. You can now review, edit and export.";
        usStatus.classList.add("status--success");
      } catch (err) {
        console.error(err);
        usStatus.textContent =
          "Unexpected error generating user stories: " + (err.message || "");
        usStatus.classList.add("status--error");
      } finally {
        generateStoriesBtn.disabled = false;
      }
    });

    function updateUserStoriesRaw() {
      if (!userStoriesRaw) return;
      const lines = userStoriesArray.map(
        (s, i) =>
          `US-${i + 1}: ${s.story || ""} (Epic: ${s.epic || "N/A"})`
      );
      userStoriesRaw.value = lines.join("\\n");
    }

    // Email Excel
    sendExcelEmailBtn.addEventListener("click", async () => {
      usEmailStatus.textContent = "";
      usEmailStatus.className = "status";

      const emailTo = (usEmailToInput.value || "").trim();
      if (!emailTo) {
        usEmailStatus.textContent = "Please enter a recipient email.";
        usEmailStatus.classList.add("status--error");
        return;
      }

      if (!lastUserStoriesFileId) {
        usEmailStatus.textContent =
          "No User Stories Excel is linked yet. Please generate and download the Excel once before emailing.";
        usEmailStatus.classList.add("status--error");
        return;
      }

      sendExcelEmailBtn.disabled = true;
      usEmailStatus.textContent = "Sending email with Excel attachment...";
      usEmailStatus.classList.remove("status--error", "status--success");

      try {
        const res = await fetch("/email-user-stories-excel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fileId: lastUserStoriesFileId,
            to: emailTo,
            projectName: usProjectNameInput.value || ""
          })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(
            err.error || "Server error while sending email."
          );
        }

        usEmailStatus.textContent =
          "Email sent successfully with User Stories Excel.";
        usEmailStatus.classList.add("status--success");
      } catch (err) {
        console.error("Email error:", err);
        usEmailStatus.textContent =
          "Failed to send email: " + (err.message || "");
        usEmailStatus.classList.add("status--error");
      } finally {
        sendExcelEmailBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
