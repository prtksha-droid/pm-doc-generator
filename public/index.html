<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Scrum Book ‚Äì AI PM Workspace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="chat-widget.css">
  <script src="chat-widget.js" defer></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #f3f4f6;
      color: #111827;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.12);
    }
    h1 {
      margin-top: 0;
    }
    p {
      margin-top: 4px;
      margin-bottom: 12px;
      font-size: 13px;
      color: #4b5563;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="date"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #ffffff;
    }
    textarea {
      resize: vertical;
      min-height: 70px;
    }
    .section {
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      background: #f9fafb;
      margin-bottom: 14px;
    }
    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #4b5563;
      margin-bottom: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .helper {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .status {
      margin-top: 8px;
      font-size: 12px;
    }
    .status--error {
      color: #b91c1c;
    }
    .status--success {
      color: #166534;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #ffffff;
      margin-right: 8px;
      margin-top: 8px;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      font-size: 12px;
    }
    code {
      font-size: 12px;
      background: #f3f4f6;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .or-divider {
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      margin: 10px 0;
      position: relative;
    }
    .or-divider::before,
    .or-divider::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #e5e7eb;
    }
    .or-divider::before {
      left: 0;
    }
    .or-divider::after {
      right: 0;
    }
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      font-size: 13px;
      flex-wrap: wrap;
      align-items: center;
    }
    .nav a {
      text-decoration: none;
      color: #2563eb;
      font-weight: 500;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 12px 16px;
      border-radius: 16px;
      background: linear-gradient(90deg, #2563eb, #1d4ed8);
      color: #ffffff;
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      font-size: 26px;
    }
    .app-name {
      font-size: 18px;
      font-weight: 700;
    }
    .app-tagline {
      font-size: 12px;
      opacity: 0.9;
    }
    .app-footer {
      margin-top: 18px;
      font-size: 11px;
      text-align: center;
      color: #6b7280;
    }

    /* =========================================================
       ADVANCED FULLY AUTOMATE UI (Scoped styles)
       ========================================================= */
    .fa-wrap{max-width:960px;margin:0 auto 18px auto;padding:0}
    .fa-header{display:flex;gap:16px;justify-content:space-between;align-items:flex-start;margin:16px 0 12px 0}
    .fa-title{font-size:18px;font-weight:800}
    .fa-subtitle{opacity:.75;margin-top:4px;font-size:12px}
    .fa-actions{display:flex;gap:10px;align-items:center}

    /* Ensure FA buttons don't inherit the global button pill style unexpectedly */
    .fa-wrap .fa-btn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin:0;
      font-size:13px;
    }
    .fa-wrap .fa-btn:disabled{opacity:.55;cursor:not-allowed}
    .fa-wrap .fa-btn-ghost{background:#fff;color:#111;border-color:#cfcfcf}

    .fa-grid{display:grid;grid-template-columns:1fr 1.3fr;gap:14px}
    .fa-card{border:1px solid #e6e6e6;border-radius:16px;padding:14px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.03)}
    .fa-card-title{font-weight:900;margin-bottom:10px;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#4b5563}
    .fa-field{margin-bottom:12px}
    .fa-label{display:block;font-weight:800;margin-bottom:6px;font-size:12px;color:#111827}
    .fa-input,.fa-textarea{width:100%;padding:10px 10px;border:1px solid #ddd;border-radius:12px;outline:none;font-size:13px}
    .fa-textarea{resize:vertical;min-height:110px}
    .fa-hint{font-size:11px;opacity:.75;margin-top:6px;color:#4b5563}
    .fa-divider{height:1px;background:#eee;margin:12px 0}
    .fa-two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .fa-pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .fa-pill{border:1px solid #eee;background:#fafafa;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:800;opacity:.95;color:#111827}
    .fa-warn{margin-top:10px;border:1px solid #ffd7d7;background:#fff2f2;color:#8a1f1f;padding:10px;border-radius:12px;font-size:12px;white-space:pre-wrap}

    .fa-stepper{display:grid;gap:8px;margin-bottom:12px}
    .fa-step{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:12px;background:#fafafa;border:1px solid #eee;font-weight:800;font-size:12px}
    .fa-step .dot{width:10px;height:10px;border-radius:50%;background:#cfcfcf;display:inline-block}
    .fa-step.active{background:#111;color:#fff;border-color:#111}
    .fa-step.active .dot{background:#fff}
    .fa-step.done{opacity:.85}

    .fa-log{border:1px solid #eee;border-radius:14px;padding:10px;background:#fcfcfc}
    .fa-log-title{font-weight:900;margin-bottom:6px;font-size:12px}
    .fa-log-body{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;max-height:140px;overflow:auto;white-space:pre-wrap}

    .fa-tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .fa-tab{
      border:1px solid #eee;background:#fff;padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:900;
      font-size:12px;margin:0;
    }
    .fa-tab.active{background:#111;color:#fff;border-color:#111}

    .fa-panel{display:none}
    .fa-panel.active{display:block}

    .fa-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px}
    .kpi{border:1px solid #eee;border-radius:14px;padding:10px;background:#fafafa}
    .kpi .k{font-size:11px;opacity:.75;font-weight:900;color:#111827}
    .kpi .v{font-size:18px;font-weight:900;margin-top:2px;color:#111827}

    .fa-mini{border:1px solid #eee;border-radius:14px;padding:10px;background:#fff;margin-top:10px}
    .fa-mini-title{font-weight:900;margin-bottom:6px;font-size:12px}
    .fa-ul{margin:0;padding-left:18px;font-size:12px;color:#111827}

    .fa-pre{background:#0b0b0b;color:#eaeaea;border-radius:14px;padding:10px;overflow:auto;max-height:220px;font-size:12px}
    .fa-pre-tall{max-height:420px}

    .fa-docgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .fa-doccard{border:1px solid #eee;border-radius:14px;padding:10px;background:#fff}
    .fa-doccard .t{font-weight:900;margin-bottom:6px;font-size:12px}

    .fa-tablewrap{border:1px solid #eee;border-radius:14px;overflow:auto}
    .fa-table{width:100%;border-collapse:collapse;font-size:12px}
    .fa-table th,.fa-table td{border-bottom:1px solid #eee;padding:8px 10px;text-align:left;vertical-align:top}
    .fa-table th{background:#fafafa;font-weight:900}
    @media (max-width: 980px){
      .fa-grid{grid-template-columns:1fr}
      .fa-docgrid{grid-template-columns:1fr}
      .fa-kpis{grid-template-columns:1fr}
    }
  
    /* =========================================================
       TABS (DOC GENERATOR vs FULLY AUTOMATE)
       Accessible pattern based on WAI-ARIA APG
       ========================================================= */
    .tabs-wrap{max-width:980px;margin:0 auto}
    .tabs-bar{display:flex;gap:8px;align-items:center;margin:14px 0 12px 0;flex-wrap:wrap}
    .tab-btn{
      border:1px solid #e5e7eb;
      background:#fff;
      color:#111827;
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      font-size:13px;
      line-height:1;
    }
    .tab-btn[aria-selected="true"]{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .tabpanel{padding-top:6px}
	
	#docgen-section-1 { display: none !important; }
</style>
</head>
<body>
  <div class="container">
    <header class="app-header">
      <div class="logo-row">
        <span class="logo-icon">üìò</span>
        <div class="logo-text">
          <div class="app-name">The Scrum Book</div>
          <div class="app-tagline">AI-powered Agile documentation &amp; delivery toolkit</div>
        </div>
      </div>
    </header>

    <h1 style="display:none;">The Scrum Book</h1>

    <div class="nav">
      <span>Navigation:</span>
      <a href="/">Main ‚Äì Document Generator</a>
      <a href="/user-stories.html">User Stories &amp; Epics</a>
      <a href="/sprint-review.html">Sprint Review (AI)</a>
      <a href="/sprint-retro.html">Sprint Retrospective (AI)</a>
      <a href="/code-review.html">Code Review (Beta)</a>
      <a href="/analytics.html">üìä Analytics (Tableau)</a>
    </div>

    <hr>

    
<div class="tabs-wrap" id="main-tabs">
  <div class="tabs-bar" role="tablist" aria-label="PM Doc Generator tabs">
    <button id="tab-automate" class="tab-btn" role="tab" aria-selected="true" aria-controls="panel-automate" type="button">‚ö° Fully Automate</button>
    <button id="tab-docgen" class="tab-btn" role="tab" aria-selected="false" aria-controls="panel-docgen" type="button">üìÑ Doc Generator</button>
  </div>

  <div id="panel-automate" class="tabpanel" role="tabpanel" aria-labelledby="tab-automate">
<!-- =========================================================
         ADVANCED FULLY AUTOMATE SECTION (NEW)
         ========================================================= -->
    <section class="fa-wrap" id="fully-automate">
      <div class="fa-header">
        <div>
          <div class="fa-title">‚ö° Fully Automate</div>
          <div class="fa-subtitle">
            One click ‚Üí Generate BRD/FRS/SOW/RAID + Epics &amp; Stories (Fibonacci) ‚Üí Publish to Confluence + Create in Jira Cloud
          </div>
        </div>

        <div class="fa-actions">
          <button class="fa-btn fa-btn-ghost" id="faBtnReset" type="button">Reset</button>
          <button class="fa-btn" id="faBtnRun" type="button">Generate &amp; Preview</button>
        </div>
      </div>

      <!-- Publish toggle (keeps existing UI; only adds behavior in JS) -->
      <label style="display:flex;gap:8px;align-items:center;margin-top:10px;">
        <input type="checkbox" id="faPublish" />
        Publish to Jira + Confluence
      </label>

      <div class="fa-grid">
        <!-- LEFT: Inputs -->
        <div class="fa-card">
          <div class="fa-card-title">Inputs</div>

          <div class="fa-field">
            <label class="fa-label">Requirements file (optional)</label>
            <input class="fa-input" type="file" id="faFile" accept=".png,.jpg,.jpeg,.pdf,.docx,.txt" />
            <div class="fa-hint">Tip: If you upload + paste text, text is treated as ‚Äúadditional notes‚Äù.</div>
          </div>

          <div class="fa-field">
            <label class="fa-label">Or paste requirements</label>
            <textarea class="fa-textarea" id="faText" rows="7" placeholder="Paste requirements here..."></textarea>
          </div>

          <div class="fa-divider"></div>

          <div class="fa-card-title">Destination (for publish)</div>
          <div class="fa-two">
            <div class="fa-field">
              <label class="fa-label">Jira Project Key</label>
              <input class="fa-input" id="faJiraProjectKey" placeholder="e.g., SCRUM" />
            </div>
            <div class="fa-field">
              <label class="fa-label">Confluence Space Key</label>
              <input class="fa-input" id="faConfluenceSpaceKey" placeholder="e.g., DOCS" />
            </div>
          </div>

          <div class="fa-two">
            <div class="fa-field">
              <label class="fa-label">Project Name (optional)</label>
              <input class="fa-input" id="faProjectName" placeholder="e.g., PM Doc Generator v2" />
            </div>
            <div class="fa-field">
              <label class="fa-label">Labels (optional)</label>
              <input class="fa-input" id="faLabels" value="auto-generated,pm-doc-generator" />
            </div>
          </div>

          <div class="fa-pills">
            <span class="fa-pill">Estimation: Fibonacci</span>
            <span class="fa-pill">Backlog: Epics + Stories</span>
            <span class="fa-pill">Mode: One-click</span>
          </div>

          <div class="fa-warn" id="faWarn" style="display:none;"></div>
        </div>

        <!-- RIGHT: Run + Outputs -->
        <div class="fa-card">
          <div class="fa-card-title">Automation Run</div>

          <div class="fa-stepper" id="faStepper">
            <div class="fa-step" data-step="1"><span class="dot"></span> Reading requirements</div>
            <div class="fa-step" data-step="2"><span class="dot"></span> Structuring scope &amp; features</div>
            <div class="fa-step" data-step="3"><span class="dot"></span> Generating docs (BRD/FRS/SOW/RAID)</div>
            <div class="fa-step" data-step="4"><span class="dot"></span> Building backlog (Epics &amp; Stories)</div>
            <div class="fa-step" data-step="5"><span class="dot"></span> Quality checks (AC, duplicates, split 13s)</div>
            <div class="fa-step" data-step="6"><span class="dot"></span> Done</div>
          </div>

          <div class="fa-log">
            <div class="fa-log-title">Live log</div>
            <div class="fa-log-body" id="faLog"></div>
          </div>

          <div class="fa-divider"></div>

          <div class="fa-tabs">
            <button class="fa-tab active" data-tab="summary" type="button">Summary</button>
            <button class="fa-tab" data-tab="docs" type="button">Docs</button>
            <button class="fa-tab" data-tab="backlog" type="button">Backlog</button>
            <button class="fa-tab" data-tab="json" type="button">Raw JSON</button>
          </div>

          <div class="fa-tabpanels">
            <div class="fa-panel active" id="faPanel-summary">
              <div class="fa-kpis">
                <div class="kpi"><div class="k">Epics</div><div class="v" id="faKpiEpics">‚Äî</div></div>
                <div class="kpi"><div class="k">Stories</div><div class="v" id="faKpiStories">‚Äî</div></div>
                <div class="kpi"><div class="k">Total Points</div><div class="v" id="faKpiPoints">‚Äî</div></div>
              </div>

              <div class="fa-mini">
                <div class="fa-mini-title">Assumptions &amp; Open Questions</div>
                <ul id="faNotes" class="fa-ul"></ul>
              </div>

              <!-- NEW: Published links (shown only when server returns published block) -->
              <div class="fa-mini" id="faPublishedBox" style="display:none;">
                <div class="fa-mini-title">Published links</div>
                <div id="faPublishedLinks" class="fa-hint"></div>
              </div>

              <div class="fa-mini">
                <div class="fa-mini-title">Next (publish)</div>
                <div class="fa-hint">
                  If you tick ‚ÄúPublish‚Äù, the app will ask the server to create Confluence pages + Jira Epics/Stories.
                </div>
              </div>
            </div>

            <div class="fa-panel" id="faPanel-docs">
              <div class="fa-docgrid">
                <div class="fa-doccard"><div class="t">BRD</div><pre id="faDocBRD" class="fa-pre"></pre></div>
                <div class="fa-doccard"><div class="t">FRS</div><pre id="faDocFRS" class="fa-pre"></pre></div>
                <div class="fa-doccard"><div class="t">SOW</div><pre id="faDocSOW" class="fa-pre"></pre></div>
                <div class="fa-doccard"><div class="t">RAID</div><pre id="faDocRAID" class="fa-pre"></pre></div>
              </div>
            </div>

            <div class="fa-panel" id="faPanel-backlog">
              <div class="fa-mini-title">Epics</div>
              <div id="faEpics"></div>

              <div class="fa-divider"></div>

              <div class="fa-mini-title">Stories</div>
              <div class="fa-tablewrap">
                <table class="fa-table" id="faStoriesTable">
                  <thead>
                    <tr>
                      <th>Epic</th>
                      <th>Summary</th>
                      <th>Priority</th>
                      <th>Points</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="fa-panel" id="faPanel-json">
              <pre id="faRaw" class="fa-pre fa-pre-tall"></pre>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="panel-docgen" class="tabpanel" role="tabpanel" aria-labelledby="tab-docgen" hidden>
<hr>

    <p>
      Upload your <strong>DOCX template</strong> with placeholders like
      <code>{projectName}</code>, <code>{background}</code>, <code>{requirements}</code>, etc.
      Fill in the fields, optionally ask AI to structure your requirements, and generate a final
      <strong>.docx</strong> that preserves the exact layout of your template ‚Äì all inside
      <strong>The Scrum Book</strong>.
    </p>

    <form id="docForm">
      <!-- 1. Template upload -->
      <div class="section" id="docgen-section-1">
	   ===== DOC GENERATOR SECTION 1 REMOVED (UI ONLY) =====
        <div class="section-title">1. DOCX Template</div>

        <label for="templateDocx">Upload Template (.docx)</label>
        <input
          type="file"
          id="templateDocx"
          name="templateDocx"
          accept=".docx"
          required
        />
        <div class="helper">
          This is your sample template. In Word, add placeholders like:
          <code>{projectName}</code>, <code>{clientName}</code>, <code>{preparedBy}</code>,
          <code>{date}</code>, <code>{version}</code>, <code>{background}</code>,
          <code>{objectives}</code>, <code>{inScope}</code>, <code>{outScope}</code>,
          <code>{stakeholders}</code>, <code>{highLevelReqs}</code>, <code>{assumptions}</code>,
          <code>{risks}</code>, <code>{requirementsTextArea}</code>, etc.
		  
		  <label>Jira Base URL</label>
<input name="jiraBaseUrl" placeholder="https://yourcompany.atlassian.net" required />

<label>Confluence Base URL</label>
<input name="confluenceBaseUrl" placeholder="https://yourcompany.atlassian.net/wiki" required />

<label>Atlassian Email</label>
<input name="atlassianEmail" placeholder="your@email.com" required />

<label>Atlassian API Token</label>
<input name="atlassianApiToken" placeholder="ATATT..." required />

<label>Confluence Space Key</label>
<input name="confluenceSpaceKey" placeholder="ENG or ~accountId" required />

<label>Jira Project Key (optional)</label>
<input name="jiraProjectKey" placeholder="MP" />

<label>Title</label>
<input name="title" value="BRD - Test" required />

<label>Requirements (paste here)</label>
<textarea name="requirementsText" rows="10" placeholder="Paste requirements here..." required></textarea>
        </div>
      </div>

      <!-- 2. Project info + document type
      <div class="section">
        <div class="section-title"> Project Info &amp; Document Type</div>
        <div class="grid-3">
          <div>
            <label for="projectName">Project Name ({projectName})</label>
            <input
              type="text"
              id="projectName"
              name="projectName"
              placeholder="e.g. Global Marketing Website Revamp"
            />
          </div>
          <div>
            <label for="clientName">Client / Stakeholder ({clientName})</label>
            <input
              type="text"
              id="clientName"
              name="clientName"
              placeholder="e.g. ACME Corp ‚Äì Marketing"
            />
          </div>
          <div>
            <label for="preparedBy">Prepared By ({preparedBy})</label>
            <input
              type="text"
              id="preparedBy"
              name="preparedBy"
              placeholder="e.g. Pratiksha Bhattacharyya"
            />
          </div>
        </div>

        <div class="grid-3" style="margin-top: 10px;">
          <div>
            <label for="date">Date ({date})</label>
            <input
              type="date"
              id="date"
              name="date"
            />
          </div>
          <div>
            <label for="version">Version ({version})</label>
            <input
              type="text"
              id="version"
              name="version"
              placeholder="e.g. 1.0"
            />
          </div>
          <div>
            <label for="docType">Document Type ({docType})</label>
            <select id="docType" name="docType">
              <option value="brd" selected>BRD</option>
              <option value="frs">FRS</option>
              <option value="sow">SOW</option>
              <option value="raid">RAID</option>
              <option value="status">Status</option>
              <option value="minutes">Minutes</option>
            </select>
            <div class="helper">
              This is mainly used in AI logic and file naming. Your DOCX template controls the layout.
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Structured sections -->
      <div class="section">
        <div class="section-title">3. Structured Sections (mapped to placeholders)</div>
        <div class="grid">
          <div>
            <label for="background">Background / Executive Summary ({background})</label>
            <textarea
              id="background"
              name="background"
              placeholder="Context, current process or system, key pain points..."
            ></textarea>
          </div>
          <div>
            <label for="objectives">Business Objectives ({objectives})</label>
            <textarea
              id="objectives"
              name="objectives"
              placeholder="Top 3‚Äì5 measurable outcomes this document aims to achieve..."
            ></textarea>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="inScope">In Scope ({inScope})</label>
            <textarea
              id="inScope"
              name="inScope"
              placeholder="What is explicitly included in this initiative..."
            ></textarea>
          </div>
          <div>
            <label for="outScope">Out of Scope ({outScope})</label>
            <textarea
              id="outScope"
              name="outScope"
              placeholder="What is explicitly excluded to avoid ambiguity..."
            ></textarea>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="stakeholders">Stakeholders ({stakeholders})</label>
            <textarea
              id="stakeholders"
              name="stakeholders"
              placeholder="Marketing, Product, Engineering, Operations..."
            ></textarea>
          </div>
          <div>
            <label for="highLevelReqs">High Level Requirements ({highLevelReqs})</label>
            <textarea
              id="highLevelReqs"
              name="highLevelReqs"
              placeholder="Bulleted list of key capabilities or modules..."
            ></textarea>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="assumptions">Assumptions ({assumptions})</label>
            <textarea
              id="assumptions"
              name="assumptions"
              placeholder="Environmental, dependency, or resource assumptions..."
            ></textarea>
          </div>
          <div>
            <label for="risks">Risks ({risks})</label>
            <textarea
              id="risks"
              name="risks"
              placeholder="Top 3‚Äì5 risks, with mitigation strategies..."
            ></textarea>
          </div>
        </div>
      </div>

      <!-- 4. Requirements / Notes text + AI checkbox -->
      <div class="section">
        <div class="section-title">4. Requirements / Notes (textarea)</div>
        <label for="requirements">Requirements / Notes ({requirementsTextArea})</label>
        <textarea
          id="requirements"
          name="requirements"
          placeholder="Paste raw requirements, notes, or user stories here."
        ></textarea>
        <div class="helper">
          This text is available in the template via <code>{requirementsTextArea}</code>.
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="useAi" />
          <label for="useAi" style="margin:0; font-weight:500;">
            ‚ú® Write with AI (auto-clean &amp; structure requirements into the sections above
            based on the selected Document Type)
          </label>
        </div>
        <div id="aiStatus" class="status"></div>
      </div>

      <div class="or-divider">or</div>

      <!-- 5. Requirements .txt upload + AI checkbox -->
      <div class="section">
        <div class="section-title">5. Requirements / Notes (upload .txt)</div>
        <label for="requirementsFile">Requirements / Notes File (.txt)</label>
        <input
          type="file"
          id="requirementsFile"
          name="requirementsFile"
          accept=".txt"
        />
        <div class="helper">
          The content of this file will be appended to the Requirements / Notes textarea.
        </div>

        <div class="checkbox-row">
          <input type="checkbox" id="useAi2" />
          <label for="useAi2" style="margin:0; font-weight:500;">
            ‚ú® Write with AI (same as above ‚Äì use AI to structure requirements)
          </label>
        </div>
        <div id="aiStatus2" class="status"></div>
      </div>

      <!-- 6. Generate button -->
      <div class="section">
        <div class="section-title">6. Generate Document</div>
        <p class="helper">
          When you click "Generate DOCX", The Scrum Book will:
        </p>
        <ul class="helper" style="padding-left: 18px;">
          <li>Load your DOCX template</li>
          <li>Fill placeholders with the fields and structured sections above</li>
          <li>Embed requirements text into <code>{requirementsTextArea}</code> if present</li>
        </ul>

        <button type="submit" id="generateBtn">Generate DOCX</button>
        <div id="status" class="status"></div>
      </div>
    </form>
  </div>
</div>

  </div>

  <footer class="app-footer">Built with ‚ù§Ô∏è by Pratiksha Bhattacharyya ¬∑ The Scrum Book</footer>

  <script>
    // =========================================================
    // Tabs: Fully Automate vs Doc Generator
    // =========================================================
    (function initTabs(){
      const tabAutomate = document.getElementById("tab-automate");
      const tabDocgen = document.getElementById("tab-docgen");
      const panelAutomate = document.getElementById("panel-automate");
      const panelDocgen = document.getElementById("panel-docgen");
      if (!tabAutomate || !tabDocgen || !panelAutomate || !panelDocgen) return;

      function setActive(which){
        const isAutomate = which === "automate";
        tabAutomate.setAttribute("aria-selected", String(isAutomate));
        tabDocgen.setAttribute("aria-selected", String(!isAutomate));
        panelAutomate.hidden = !isAutomate;
        panelDocgen.hidden = isAutomate;
        try { localStorage.setItem("tsb_active_tab", which); } catch(e) {}
      }

      tabAutomate.addEventListener("click", () => setActive("automate"));
      tabDocgen.addEventListener("click", () => setActive("docgen"));

      // Restore last tab
      try {
        const saved = localStorage.getItem("tsb_active_tab");
        if (saved === "docgen" || saved === "automate") setActive(saved);
      } catch(e) {}

      // If user navigates to #fully-automate, open that tab
      if (location.hash && location.hash.includes("fully-automate")) setActive("automate");
    })();

    // Prefill date with today
    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("date");
      if (dateInput && !dateInput.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;
      }
    });

    const form = document.getElementById("docForm");
    const statusEl = document.getElementById("status");
    const generateBtn = document.getElementById("generateBtn");
    const aiStatus = document.getElementById("aiStatus");
    const aiStatus2 = document.getElementById("aiStatus2");
    const useAiCheckbox = document.getElementById("useAi");
    const useAiCheckbox2 = document.getElementById("useAi2");
    const requirementsFileInput = document.getElementById("requirementsFile");
    const requirementsTextarea = document.getElementById("requirements");

    // Keep the two AI checkboxes in sync
    if (useAiCheckbox && useAiCheckbox2) {
      useAiCheckbox.addEventListener("change", () => {
        useAiCheckbox2.checked = useAiCheckbox.checked;
      });
      useAiCheckbox2.addEventListener("change", () => {
        useAiCheckbox.checked = useAiCheckbox2.checked;
      });
    }

    // Auto-load TXT file into requirements textarea
    if (requirementsFileInput && requirementsTextarea) {
      requirementsFileInput.addEventListener("change", () => {
        const file = requirementsFileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result || "";
          if (requirementsTextarea.value.trim()) {
            requirementsTextarea.value += "\n\n" + text;
          } else {
            requirementsTextarea.value = text;
          }
        };
        reader.readAsText(file);
      });
    }

    async function callAiDraftIfNeeded() {
      const useAi = useAiCheckbox && useAiCheckbox.checked;
      if (!useAi || !requirementsTextarea) return null;

      if (aiStatus) {
        aiStatus.textContent = "Calling AI to structure requirements...";
        aiStatus.className = "status";
      }
      if (aiStatus2) {
        aiStatus2.textContent = "Calling AI to structure requirements...";
        aiStatus2.className = "status";
      }

      try {
        const requirements = requirementsTextarea.value || "";
        const docType = (document.getElementById("docType")?.value || "brd").toLowerCase();

        let docTypeInstructions = "";
        if (docType === "brd") {
          docTypeInstructions =
            "Document type is BRD (Business Requirements Document). Focus on business background, objectives, scope, stakeholders, and high-level requirements.";
        } else if (docType === "frs") {
          docTypeInstructions =
            "Document type is FRS (Functional Requirements Specification). Focus on system behaviour, functional use cases, inputs, outputs, and rules.";
        } else if (docType === "sow") {
          docTypeInstructions =
            "Document type is SOW (Statement of Work). Focus on deliverables, scope, timelines, responsibilities, and acceptance criteria.";
        } else if (docType === "raid") {
          docTypeInstructions =
            "Document type is RAID (Risks, Assumptions, Issues, Dependencies). Focus on clearly listing each RAID item with description and owner.";
        } else if (docType === "status") {
          docTypeInstructions =
            "Document type is Status Report. Focus on current status, progress, risks, and next steps.";
        } else if (docType === "minutes") {
          docTypeInstructions =
            "Document type is Minutes of Meeting. Focus on agenda, discussion points, decisions, and action items.";
        }

        const prompt = `
You are helping a project manager prepare a structured ${docType.toUpperCase()} document.

${docTypeInstructions}

Raw Requirements / Notes:
${requirements}

Tasks:
1. Clean and structure the raw requirements text.
2. Allocate content into the following fields, if relevant:
   - cleanedRequirements  (a cleaned version of the full text)
   - background
   - objectives
   - inScope
   - outScope
   - stakeholders
   - highLevelReqs
   - assumptions
   - risks

Return ONLY JSON with this structure (omit fields that are not applicable):

{
  "cleanedRequirements": "...",
  "background": "...",
  "objectives": "...",
  "inScope": "...",
  "outScope": "...",
  "stakeholders": "...",
  "highLevelReqs": "...",
  "assumptions": "...",
  "risks": "..."
}
`.trim();

        const res = await fetch("/ai-draft", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          const msg =
            "AI error: " +
            (err.error ||
              "AI could not process the requirements. You can still generate the document manually.");
          if (aiStatus) {
            aiStatus.textContent = msg;
            aiStatus.className = "status status--error";
          }
          if (aiStatus2) {
            aiStatus2.textContent = msg;
            aiStatus2.className = "status status--error";
          }
          return null;
        }

        const data = await res.json();
        const parsed = data.parsed || {};

        // Fill structured fields if not already filled
        const setIfEmpty = (id, key) => {
          const el = document.getElementById(id);
          if (!el) return;
          if (!el.value.trim() && parsed[key]) {
            el.value = parsed[key];
          }
        };

        setIfEmpty("background", "background");
        setIfEmpty("objectives", "objectives");
        setIfEmpty("inScope", "inScope");
        setIfEmpty("outScope", "outScope");
        setIfEmpty("stakeholders", "stakeholders");
        setIfEmpty("highLevelReqs", "highLevelReqs");
        setIfEmpty("assumptions", "assumptions");
        setIfEmpty("risks", "risks");

        if (parsed.cleanedRequirements) {
          requirementsTextarea.value = parsed.cleanedRequirements;
        }

        if (aiStatus) {
          aiStatus.textContent = "AI draft applied successfully.";
          aiStatus.className = "status status--success";
        }
        if (aiStatus2) {
          aiStatus2.textContent = "AI draft applied successfully.";
          aiStatus2.className = "status status--success";
        }

        return parsed;
      } catch (err) {
        console.error("AI draft error:", err);
        if (aiStatus) {
          aiStatus.textContent =
            "AI draft error: " + (err.message || "Unknown error.");
          aiStatus.className = "status status--error";
        }
        if (aiStatus2) {
          aiStatus2.textContent =
            "AI draft error: " + (err.message || "Unknown error.");
          aiStatus2.className = "status status--error";
        }
        return null;
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (aiStatus) {
        aiStatus.textContent = "";
        aiStatus.className = "status";
      }
      if (aiStatus2) {
        aiStatus2.textContent = "";
        aiStatus2.className = "status";
      }

      const templateInput = document.getElementById("templateDocx");
      if (!templateInput.files || !templateInput.files[0]) {
        statusEl.textContent = "Please upload a DOCX template.";
        statusEl.classList.add("status--error");
        return;
      }

      generateBtn.disabled = true;
      statusEl.textContent = "Preparing document...";

      try {
        const useAi = useAiCheckbox && useAiCheckbox.checked;
        if (useAi) {
          await callAiDraftIfNeeded();
        }

        const formData = new FormData(form);
        formData.append("templateDocx", templateInput.files[0]);

        const res = await fetch("/generate-docx", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          statusEl.textContent =
            "Error generating document: " + (text || res.statusText);
          statusEl.classList.add("status--error");
          return;
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");

        const projectName = document
          .getElementById("projectName")
          ?.value?.trim();
        const docType = document.getElementById("docType")?.value || "brd";

        const safeProject = (projectName || "project")
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-|-$/g, "");

        a.href = url;
        a.download = `${safeProject || "project"}-${docType || "brd"}-generated.docx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        statusEl.textContent = "Document generated and downloaded successfully.";
        statusEl.classList.add("status--success");
      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "Unexpected error generating document: " + (err.message || "");
        statusEl.classList.add("status--error");
      } finally {
        generateBtn.disabled = false;
      }
    });
  </script>

  <!-- =========================================================
       ADVANCED FULLY AUTOMATE SCRIPT (UPDATED - NO DELETIONS)
       ========================================================= -->
  <script>
    // ---------- helpers ----------
    const $fa = (id) => document.getElementById(id);

    function faLog(msg) {
      const el = $fa("faLog");
      if (!el) return;
      const ts = new Date().toLocaleTimeString();
      el.textContent += `[${ts}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    function faSetWarn(text) {
      const w = $fa("faWarn");
      if (!w) return;
      if (!text) { w.style.display = "none"; w.textContent = ""; return; }
      w.style.display = "block";
      w.textContent = text;
    }

    function faSetStep(activeStep, doneSteps = []) {
      document.querySelectorAll("#faStepper .fa-step").forEach((el) => {
        const n = Number(el.getAttribute("data-step"));
        el.classList.remove("active");
        el.classList.remove("done");
        if (doneSteps.includes(n)) el.classList.add("done");
        if (n === activeStep) el.classList.add("active");
      });
    }

    function faSetTab(tabKey) {
      document.querySelectorAll(".fa-tab").forEach((b) => {
        b.classList.toggle("active", b.getAttribute("data-tab") === tabKey);
      });
      ["summary","docs","backlog","json"].forEach((k) => {
        const panel = $fa("faPanel-" + k);
        if (panel) panel.classList.toggle("active", k === tabKey);
      });
    }

    function faEscapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function faDocToText(doc) {
      if (!doc) return "";
      const title = doc.title ? `# ${doc.title}\n\n` : "";
      const secs = Array.isArray(doc.sections)
        ? doc.sections.map((x) => `## ${x.h || ""}\n${x.body || ""}\n`).join("\n")
        : "";
      return (title + secs).trim();
    }

    function faRaidToText(raid) {
      if (!raid) return "";
      const title = raid.title ? `# ${raid.title}\n\n` : "";
      const block = (name, items) => {
        const arr = Array.isArray(items) ? items : [];
        const lines = arr.length
          ? arr.map((x) =>
              `- ${x.item || ""} (Owner: ${x.owner || "TBD"}, Status: ${x.status || "TBD"})` +
              (x.mitigation ? " | Mitigation: " + x.mitigation : "")
            ).join("\n")
          : "- (none)";
        return `## ${name}\n${lines}\n`;
      };
      return [
        title,
        block("Risks", raid.risks),
        block("Assumptions", raid.assumptions),
        block("Issues", raid.issues),
        block("Dependencies", raid.dependencies),
      ].join("\n").trim();
    }

    function faRenderPublished(published) {
      const box = $fa("faPublishedBox");
      const links = $fa("faPublishedLinks");
      if (!box || !links) return;

      if (!published) {
        box.style.display = "none";
        links.innerHTML = "";
        return;
      }

      const c = published.confluence || {};
      const j = published.jira || {};

      const linkLine = (url, label) =>
        url ? `<div>‚Ä¢ <a href="${url}" target="_blank" rel="noreferrer">${faEscapeHtml(label)}</a></div>` : "";

      box.style.display = "block";
      links.innerHTML = `
        <div style="margin-bottom:8px;"><b>Confluence</b></div>
        ${linkLine(c.parent, "Open Doc Pack")}
        ${linkLine(c.brd, "BRD")}
        ${linkLine(c.frs, "FRS")}
        ${linkLine(c.sow, "SOW")}
        ${linkLine(c.raid, "RAID")}
        <div style="margin:10px 0 8px;"><b>Jira</b></div>
        <div><b>Epics:</b> ${faEscapeHtml((j.epics || []).join(", ") || "‚Äî")}</div>
        <div><b>Stories:</b> ${faEscapeHtml((j.stories || []).join(", ") || "‚Äî")}</div>
      `;
    }

    function faRenderOutput(out) {
      $fa("faRaw").textContent = JSON.stringify(out, null, 2);

      const epics = out?.backlog?.epics || [];
      const stories = out?.backlog?.stories || [];

      $fa("faKpiEpics").textContent = epics.length;
      $fa("faKpiStories").textContent = stories.length;
      const totalPoints = stories.reduce((s, x) => s + (Number(x.storyPoints) || 0), 0);
      $fa("faKpiPoints").textContent = totalPoints;

      // notes
      const notesEl = $fa("faNotes");
      const assumptions = out?.notes?.assumptions || [];
      const openQs = out?.notes?.openQuestions || [];
      const allNotes = [
        ...assumptions.map((x) => "Assumption: " + x),
        ...openQs.map((x) => "Open question: " + x),
      ];
      notesEl.innerHTML = allNotes.length
        ? allNotes.map((x) => `<li>${faEscapeHtml(x)}</li>`).join("")
        : "<li>No assumptions captured.</li>";

      // docs
      $fa("faDocBRD").textContent = faDocToText(out?.docs?.brd);
      $fa("faDocFRS").textContent = faDocToText(out?.docs?.frs);
      $fa("faDocSOW").textContent = faDocToText(out?.docs?.sow);
      $fa("faDocRAID").textContent = faRaidToText(out?.docs?.raid);

      // epics list
      $fa("faEpics").innerHTML = epics.map((e) => `
        <div class="fa-mini" style="margin:8px 0">
          <div style="font-weight:900">${faEscapeHtml(e.name || "")}</div>
          <div style="opacity:.8;margin-top:4px">${faEscapeHtml(e.description || "")}</div>
        </div>
      `).join("");

      // stories table
      const tbody = $fa("faStoriesTable").querySelector("tbody");
      tbody.innerHTML = stories.map((s) => `
        <tr>
          <td>${faEscapeHtml(s.epicName || "")}</td>
          <td>
            <div style="font-weight:900">${faEscapeHtml(s.summary || "")}</div>
            <div style="opacity:.75;margin-top:4px">${faEscapeHtml(s.story || "")}</div>
          </td>
          <td><span class="fa-pill">${faEscapeHtml(s.priority || "")}</span></td>
          <td style="font-weight:900">${faEscapeHtml(String(s.storyPoints ?? ""))}</td>
        </tr>
      `).join("");
    }

    function faResetUI() {
      if ($fa("faText")) $fa("faText").value = "";
      if ($fa("faFile")) $fa("faFile").value = "";
      if ($fa("faLog")) $fa("faLog").textContent = "";
      if ($fa("faRaw")) $fa("faRaw").textContent = "";
      if ($fa("faKpiEpics")) $fa("faKpiEpics").textContent = "‚Äî";
      if ($fa("faKpiStories")) $fa("faKpiStories").textContent = "‚Äî";
      if ($fa("faKpiPoints")) $fa("faKpiPoints").textContent = "‚Äî";
      if ($fa("faNotes")) $fa("faNotes").innerHTML = "";
      if ($fa("faDocBRD")) $fa("faDocBRD").textContent = "";
      if ($fa("faDocFRS")) $fa("faDocFRS").textContent = "";
      if ($fa("faDocSOW")) $fa("faDocSOW").textContent = "";
      if ($fa("faDocRAID")) $fa("faDocRAID").textContent = "";
      if ($fa("faEpics")) $fa("faEpics").innerHTML = "";
      if ($fa("faStoriesTable")) $fa("faStoriesTable").querySelector("tbody").innerHTML = "";
      faRenderPublished(null); // NEW: reset published box
      faSetWarn("");
      faSetStep(1, []);
      faSetTab("summary");
    }

    function faSleep(ms){ return new Promise((r)=>setTimeout(r,ms)); }

    // Preserve function name
    async function runFullyAutomate() {
      faSetWarn("");
      if ($fa("faLog")) $fa("faLog").textContent = "";
      faSetTab("summary");
      faRenderPublished(null); // NEW: clear previous published links

      const text = ($fa("faText")?.value || "");
      const file = ($fa("faFile")?.files && $fa("faFile").files[0]) ? $fa("faFile").files[0] : null;

      if (!text.trim() && !file) {
        faSetWarn("Please paste requirements or upload a file.");
        return;
      }

      const btn = $fa("faBtnRun");
      if (btn) btn.disabled = true;

      try {
        faSetStep(1, []); faLog("Starting run‚Ä¶");
        await faSleep(150);

        faSetStep(2, [1]); faLog("Structuring requirements‚Ä¶");
        await faSleep(150);

        faSetStep(3, [1,2]); faLog("Generating doc pack‚Ä¶");
        await faSleep(150);

        faSetStep(4, [1,2,3]); faLog("Building backlog (epics & stories)‚Ä¶");
        await faSleep(150);

        faSetStep(5, [1,2,3,4]); faLog("Running quality checks‚Ä¶");
        await faSleep(150);

        const fd = new FormData();
        fd.append("requirementsText", text);
        if (file) fd.append("requirementsFile", file);

        fd.append("projectName", $fa("faProjectName")?.value || "");
        fd.append("jiraProjectKey", $fa("faJiraProjectKey")?.value || "");
        fd.append("confluenceSpaceKey", $fa("faConfluenceSpaceKey")?.value || "");
        fd.append("labels", $fa("faLabels")?.value || "");

        // ‚úÖ NEW: actually send publish flag
        fd.append("publish", $fa("faPublish")?.checked ? "true" : "false");

        faLog("Calling /fully-automate‚Ä¶");
        const res = await fetch("/fully-automate", { method: "POST", body: fd });
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data?.error || "Failed to run fully automate.");
        }

        const out = data.output || data.parsed || data;
        faLog("Received output JSON.");
        faSetStep(6, [1,2,3,4,5]);
        faRenderOutput(out);

        // ‚úÖ NEW: show published links if present
        if (data.published) {
          faLog("Publish completed. Rendering links‚Ä¶");
          faRenderPublished(data.published);
        } else {
          faRenderPublished(null);
        }

        faLog("Done ‚úÖ");
      } catch (e) {
        console.error(e);
        faSetWarn(e?.message || String(e));
        faLog("Run failed ‚ùå");
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    // Wire up events after DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".fa-tab").forEach((b) => {
        b.addEventListener("click", () => faSetTab(b.getAttribute("data-tab")));
      });

      const resetBtn = $fa("faBtnReset");
      if (resetBtn) resetBtn.addEventListener("click", faResetUI);

      const runBtn = $fa("faBtnRun");
      if (runBtn) runBtn.addEventListener("click", runFullyAutomate);

      // ‚úÖ NEW: update button label when publish toggles
      const pub = $fa("faPublish");
      if (pub && runBtn) {
        const sync = () => {
          runBtn.textContent = pub.checked ? "Generate & Publish" : "Generate & Preview";
        };
        pub.addEventListener("change", sync);
        sync();
      }

      faResetUI();
    });
  </script>

</body>
</html>
